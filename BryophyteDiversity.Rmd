---
title: "Analysis of Bryophyte Richness and Diversity in the Americas"
author: Carter Powell, Jackie O'Malley, and Julia Eckberg
output: html_notebook
---

```{r, echo=FALSE}
require(knitr)
require(BIEN)
require(ape)
require(maps)
require(dplyr)
require(maptools)
require(raster)
require(dismo)
require(sp)
require(rgdal)
require(mapdata)
require(mapproj)
require(vegan)
require(letsR)
require(entropart)
require(betapart)
require(CommEcol)
require(rgeos)
require(rlist)
```

As an extension of the work done by Carter Powell '20, who mapped alpha diversity of bryophytes in the Americas using species distribution data from the BIEN database, we have calculated and mapped beta diversity of bryophytes in the Western Hemisphere. 

Our analysis begins with bryophyte presence data from BIEN, which was constructed through species distribution modeling based on occurrence records for 4,802 species. We convert this data to a species-by-cell presence-absence matrix in order to calculate beta diversity using the 'betadiver' function from the *vegan* package. The resulting "BetaMat.rds" file is a Jacccard similarity matrix showing the beta diversity for each pair of cells. Additionally, we load a blank raster file containing 100km by 100km cells, a numeric vector equal to the number of cells in the raster, cell richness (alpha diversity) data, and a vector of the Cell IDs for each occuppied cell. 

```{r}
BlankRas <-raster("Data/blank_100km_raster.tif")
CellRichness <- readRDS("Data/CellRichness.rds")
CellID <- CellRichness$CellID
CellVec <- c(1:15038)

BetaMat <- readRDS("Data/BetaMat.rds")
BetaMat<-as.matrix(BetaMat)
row.names(BetaMat) <- CellID
names(BetaMat) <- CellID
```

In order to identify and isolate the occuppied cells with 7 or 8 occcuppied neighbor cells, we use the 'adjacent' function from the *raster* package, and apply it to the vector of cell IDs. The output is a list including each occuppied cell and the cells that neighbor it. We then convert this list to a vector from which we extract the cells with 7 or 8 occuppied neighbors, creating two new vectors.

```{r}
neighbor <- function(CellVec) {(adjacent(BlankRas, CellVec, directions=8, pairs=FALSE, target=CellID, sorted=TRUE, include=FALSE, id=FALSE))}
Neighbors <- lapply(CellVec, neighbor)
names(Neighbors) <- CellVec

bryneighbors <- Neighbors[CellID]
bryneighborvect <- unlist(lapply(bryneighbors, length))

Cell8 <- CellID[which(bryneighborvect==8)]
Neighbors8 <-Neighbors[Cell8]
Neighbors8 <- data.frame(Neighbors8)
names(Neighbors8) <- Cell8

Cell7 <- CellID[which(bryneighborvect==7)]
Neighbors7 <- Neighbors[Cell7]
Neighbors7 <- data.frame(Neighbors7)
names(Neighbors7) <- Cell7
```


Next, we create two new beta diversity matrices for the cells with 7 neighbors and those with 8 neighbors, respectively. 
```{r}
BetaMat8<- BetaMat[!Cell8, !Cell8, drop=TRUE]
inx8 <- match(as.character(Cell8), rownames(BetaMat8))
BetaMat8 <- BetaMat8[inx8,inx8]

BetaMat7 <- BetaMat[!Cell7, !Cell7, drop=TRUE]
inx7 <- match(as.character(Cell7), rownames(BetaMat7))
BetaMat7 <- BetaMat7[inx7,inx7]
```


For each cell, pairwise beta diversity is extracted for that focal cell and each of its 8 or 7 neighbors, and the mean of those values is calculated (McFadden *et al.* 2019). 

```{r}
Cell8CH <- as.character(Cell8)
Beta8 <- lapply(Cell8CH, function(x)mean(BetaMat[x, as.character(Neighbors8[,x])]))
names(Beta8) <- Cell8CH

Cell7CH <- as.character(Cell7)
Beta7 <- lapply(Cell7CH, function(x)mean(BetaMat[x, as.character(Neighbors7[,x])]))
names(Beta7) <- Cell7CH
```


#Plot mean pairwise beta diversity by Cell ID
```{r}
Beta7Vec<-unlist(Beta7)
Beta8Vec<-unlist(Beta8)

BetaVec <- rep(0, 15038)

BetaVec[Cell8]<-Beta8Vec
BetaVec[Cell7]<-Beta7Vec
BetaVec[BetaVec==0]<-NA

plot(BetaVec, ylab = "Mean Pairwise β-Diversity", xlab = "Cell ID")
```


#Load mapping packages and create colorscheme
```{r}
require(wesanderson)
require(ggplot2)
require(rasterVis)

cols <- rev(wes_palette("Zissou1", 500, type = "continuous"))
```


#Map beta diversity, adjust minimum value to remove outliers
```{r}
BetaRaster <- setValues(BlankRas, BetaVec)
BetaPoints<-rasterToPoints(BetaRaster)

BetaDF <- data.frame(BetaPoints)
colnames(BetaDF) <- c("Longitude", "Latitude", "MAP")

theme_set(theme_void())
RawBetaMap <- ggplot() + geom_tile(data=BetaDF, aes(x=Longitude, y=Latitude, fill=MAP)) + 
    scale_fill_gradientn(name="β-diversity", colours=cols, na.value="transparent", limits = c(0,1)) + 
    coord_equal()

RawBetaMap
```


#Map low beta values
```{r}
LowBetaVec <- rep(0, 15038)
LowBetaVec[Cell8]<-Beta8Vec
LowBetaVec[Cell7]<-Beta7Vec
LowBetaVec[LowBetaVec==0]<-NA
LowBetaVec[LowBetaVec>0.5]<-NA

LowBetaRaster <- setValues(BlankRas, LowBetaVec)
LowBetaPoints<-rasterToPoints(LowBetaRaster)
LowBetaDF <- data.frame(LowBetaPoints)
colnames(LowBetaDF) <- c("Longitude", "Latitude", "MAP")

theme_set(theme_void())
LowBetaMap <- gplot(LowBetaRaster, maxpixels=15038) +  geom_tile(aes(fill = value)) + 
    scale_fill_gradientn(colours="black", na.value="transparent", limits = c(0,1)) + theme(legend.position = "none") + 
    coord_equal() 
LowBetaMap
```


#Map beta diversity with values under 0.5 shown in dark grey (19 values are under 0.5)
```{r}
source("Functions/gplot_data.R")
gplotB<- gplot_data(BetaRaster)
gplotLB<- gplot_data(LowBetaRaster)

BetaMap <- ggplot() +
  geom_tile(data = dplyr::filter(gplotLB, !is.na(value)), 
            aes(x = x, y = y), fill = "gray25") +
  geom_tile(data = gplotB, 
            aes(x = x, y = y, fill = value)) +
  scale_fill_gradientn(name="β-diversity", colours=cols, na.value="transparent", limits = c(0.5,1)) +
  coord_quickmap()
BetaMap
```


#Map alpha diversity (aka richness)
```{r}
RichnessVec <- readRDS("Data/RichnessVec.rds")
RichnessVec[which(RichnessVec==0)]=NA
RichnessRaster <- setValues(BlankRas, RichnessVec)

theme_set(theme_void())
RichnessMap <- gplot(RichnessRaster, maxpixels=15038) + geom_tile(aes(fill = value)) +   
    scale_fill_gradientn(name="α-diversity", colours=cols, na.value="transparent") +
    coord_equal() 
RichnessMap
```


#Map alpha and beta diversity side-by-side and save as png
```{r}
require(gridExtra)

png("bothmaps.png", width = 1000, height = 1000, pointsize = 20)
grid.arrange(RichnessMap, BetaMap, ncol=2)
dev.off()
```


#Plot Jaccard index against Sorensen (both are SIMILARITY)
```{r}
SorBetaVec <- readRDS("Data/SorBetaVec.rds")
SorBetaVec[SorBetaVec<0]<-NA
BetaVec[BetaVec<0]<-NA

plot(BetaVec, ylab = "β-diversity", xlab = "Cell ID", col="darkgreen")
points(SorBetaVec, col="skyblue2")
```


#Histogram of beta values
```{r}
BetaDF <- as.data.frame(BetaVec)
BetaPolygons <- rasterToPolygons(BetaRaster)

SorBetaRaster <- setValues(BlankRas, SorBetaVec)

histogram(BetaRaster, col=(rev(cols)))
histogram(SorBetaRaster, col=((cols)))
```


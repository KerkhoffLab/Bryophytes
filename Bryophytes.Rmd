---
title: "Analysis of Bryophyte Richness and Diversity in the Americas"
author: Carter Powell, Jackie O'Malley, and Julia Eckberg
output: html_notebook
---

```{r}
require(knitr)
require(BIEN)
require(ape)
require(maps)
require(dplyr)
require(maptools)
require(raster)
require(dismo)
require(sp)
require(rgdal)
require(mapdata)
require(mapproj)
require(vegan)
require(letsR)
require(entropart)
require(betapart)
require(rgeos)
require(CommEcol)
require(rlist)
```

#Load and process data
```{r, eval=TRUE, echo=FALSE}
source("Scripts/DataLoading.R")
source("Scripts/DataProcessing.R")
```


#Create occurrence by cell matrix by reshaping dataframe, then convert to presence-absence matrix
```{r}
require(reshape2)

SpeciesCellID <- BryophytePresence[,c(1,4)]
melted <- melt(SpeciesCellID, id=c("Species", "CellID"), na.rm = TRUE)

SpeciesCellMatrix <- acast(melted, CellID~Species, margins=FALSE)
SpeciesCellMatrix[SpeciesCellMatrix > 0] <- 1

```

#The original beta matrix for ALL CELL PAIRS!!!
```{r}
#betadiver(help = TRUE)
full.beta <- betadiver(SpeciesCellMatrix, method = "sor", order = FALSE, help = FALSE)
```


#Using betadiver to compute B-diversity using Jaccard dissimilarity
```{r}
betamat <- betadiver(SpeciesCellMatrix, method = "sor", order = FALSE, help = FALSE)
head(betamat)
```


#Using vegdist to compute B-diversity using presence-absence data
```{r}
#JaccardMatrix <- vegdist(SpeciesCellMatrix, method="jaccard", binary=TRUE, upper=FALSE)

```


#Identify OCCUPPIED cells that are adjacent to each occuppied cell
```{r}
cellID <- tally$CellID

cellvector <- c(1:15038)
neighbor <- function(cellvector) {(adjacent(BIENblank, cellvector, directions=8, pairs=FALSE, target=cellID, sorted=TRUE, include=FALSE, id=FALSE))}
neighbors <- lapply(cellvector, neighbor)
names(neighbors) <- cellvector

bryneighbors <- neighbors[cellID]
```


#Separate out occuppied cells with 8 occuppied neighbors
```{r}
bryneighborvect <- unlist(lapply(bryneighbors, length))

cell8 <- cellID[which(bryneighborvect==8)]
cell7 <- cellID[which(bryneighborvect==7)]

betamat8<-as.matrix(betamat)
betamat8[!cell8, !cell8, drop=TRUE]

betamat7<-as.matrix(betamat)
betamat7[!cell7, !cell7, drop=TRUE]

inx8 <- match(as.character(cell8), rownames(betamat8))
inx7 <- match(as.character(cell7), rownames(betamat7))

betamat8 <- betamat8[inx8,inx8]
betamat7 <- betamat7[inx7,inx7]
```

#Trying to extract the vector of neighbors for each cell with 8 neighbors
```{r}
bry8neighbors <-neighbors[cell8]
bry7neighbors <- neighbors[cell7]

bry8neighbors <- data.frame(bry8neighbors)
names(bry8neighbors)[1:3788] <- cell8
bry7neighbors <- data.frame(bry7neighbors)
names(bry7neighbors)[1:318] <- cell7

row.names(betamat8) <- cell8
names(betamat8)[1:3788] <- cell8
row.names(betamat7) <- cell7
names(betamat7)[1:318] <- cell7


full.betamat <- as.matrix(full.beta)
row.names(full.betamat) <- cellID
names(full.betamat)[1:4761] <- cellID

#neighborlist <- as.list(cell8)
```


#Beta diversity for each cell and its 8neighbors
```{r}
cell8_ch <- as.character(cell8)
cell7_ch <- as.character(cell7)

ultimatebeta8 <- lapply(cell8_ch, function(x)mean(full.betamat[x, as.character(bry8neighbors[,x])]))
names(ultimatebeta8) <- cell8_ch

ultimatebeta7 <- lapply(cell7_ch, function(x)mean(full.betamat[x, as.character(bry7neighbors[,x])]))
names(ultimatebeta7) <- cell7_ch

plot(cell8_ch, ultimatebeta8)
plot(cell7_ch, ultimatebeta7)

points(cell7_ch, ultimatebeta7)

#check on cell 767. it has crazy LOW value
```


#Plot richness
```{r}
betavector7<-unlist(ultimatebeta7)
betavector8<-unlist(ultimatebeta8)
cellmatrix <- as.matrix(cellvector)
x <- rep(0,15038)
x
x[cell8]<-betavector8
x[cell7]<-betavector7
x[x==0]<-NA
plot(cellvector, x)

#MAP
#require(RColorBrewer)
#cols<-brewer.pal(5, "YlGn")
require(wesanderson)
cols <- rev(wes_palette("Zissou1", 500, type = "continuous"))
require(rasterVis)
#different way to plot, easier to mess with the breaks

x[x<0.5]<-NA
cellmatrix<-cbind(cellmatrix, x)
cellmatrix<-cellmatrix[,-1]

betavector<-as.vector(cellmatrix)
BetaRaster <- setValues(BIENblank, betavector)
spplot(BetaRaster,  maxpixels=15038, col.regions=cols)
gplot(BetaRaster,  maxpixels=15038)

library(ggplot2)

theme_set(theme_void())
gplot(BetaRaster) + geom_raster(aes(fill = value))+ scale_fill_gradientn(colours=cols) +
          coord_equal()

#plot(BetaRaster, col=rev(cols), axes = F)
```

#RasterVis test
```{r}
require(rasterVis)
```

#Try out beta raster
```{r}
#betavector <- as.vector(t(beta))
#betavector <- as.vector(t(beta))
#BetaRaster <- setValues(BIENblank, betavector)
```

#Trying out betadisper
```{r}
#betadisper(beta, group, type = c("median","centroid"), bias.adjust = FALSE,
       #sqrt.dist = FALSE, add = FALSE)
```


#Compute Jaccard dissimilarity for all pairs of sites
```{r}
#JaccardMatrix <- vegdist(SpeciesCellMatrix, method="jaccard", binary=TRUE, upper=TRUE)
```

#Convert blank raster to shapefile
```{r, eval=FALSE}
crs_ref <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"  
BIENblank_tmp <- projectRaster(BIENblank, crs = crs_ref)

BIENpoints <- rasterToPoints(BIENblank_tmp, spatial  = TRUE)
proj4string(BIENpoints)

BIENpoints <- spTransform(BIENpoints, CRS(crs_ref))

BIENpoints@data <- data.frame(BIENpoints@data, long=coordinates(BIENpoints) [,1], lat=coordinates(BIENpoints) [,2])
head(BIENpoints@data, n=20)

BIENpolygons <- rasterToPolygons(BIENblank_tmp, fun = NULL, na.rm = TRUE, n=8, digits = 12)
BIENpolygons
```


#Trying out betagrid
```{r}
#print(betagrid)
#betagrid(gridshp=BIENpolygons, comp = SpeciesCellMatrix, xfeature = 2, yfeature = 3, radius = 0.25,index = "jaccard")
```


#Trying out betagrid2
```{r}
#PresAbTable <- read.table(SpeciesCellMatrix, row.names=1, head=T)
#print(betagrid2)
#betagrid2(SpeciesCellMatrix, radius = 100)
```

---
title: "Analysis of Bryophyte Richness and Diversity in the Americas"
author: Carter Powell, Jackie O'Malley, and Julia Eckberg
output: html_notebook
---

```{r}
require(knitr)
require(BIEN)
require(ape)
require(maps)
require(dplyr)
require(maptools)
require(raster)
require(dismo)
require(sp)
require(rgdal)
require(mapdata)
require(mapproj)
require(vegan)
require(letsR)
require(entropart)
require(betapart)
require(CommEcol)
require(rgeos)
require(rlist)
```


#Load blank raster and cell richness data + extract cell IDs and create vector for all cells
#Change file for BetaMat and CellRichness depending on if you want to map bryophytes, mosses, liverworts, etc. 

```{r}
BlankRas <-raster("Data/blank_100km_raster.tif")
BetaMat <- readRDS("Data/BetaMat.rds")
CellRichness <- readRDS("Data/CellRichness.rds")
CellID <- CellRichness$CellID
CellVec <- c(1:15038)
```


#Identify occupied cells that are adjacent to each occuppied cell + convert to vector
```{r}
neighbor <- function(CellVec) {(adjacent(BlankRas, CellVec, directions=8, pairs=FALSE, target=CellID, sorted=TRUE, include=FALSE, id=FALSE))}
Neighbors <- lapply(CellVec, neighbor)
names(Neighbors) <- CellVec

bryneighbors <- Neighbors[CellID]
bryneighborvect <- unlist(lapply(bryneighbors, length))
```


#Separate out occuppied cells with 8 and 7 occuppied neighbors
```{r}
Cell8 <- CellID[which(bryneighborvect==8)]
Neighbors8 <-Neighbors[Cell8]
Neighbors8 <- data.frame(Neighbors8)
names(Neighbors8) <- Cell8

Cell7 <- CellID[which(bryneighborvect==7)]
Neighbors7 <- Neighbors[Cell7]
Neighbors7 <- data.frame(Neighbors7)
names(Neighbors7) <- Cell7
```


#Make beta diversity matrix for all cells
```{r}
BetaMat<-as.matrix(BetaMat)
row.names(BetaMat) <- CellID
names(BetaMat) <- CellID
```


#Make beta diversity matrix for cells with 8 neighbors and cells with 7 neighbors
```{r}
BetaMat8<- BetaMat[!Cell8, !Cell8, drop=TRUE]
inx8 <- match(as.character(Cell8), rownames(BetaMat8))
BetaMat8 <- BetaMat8[inx8,inx8]

BetaMat7 <- BetaMat[!Cell7, !Cell7, drop=TRUE]
inx7 <- match(as.character(Cell7), rownames(BetaMat7))
BetaMat7 <- BetaMat7[inx7,inx7]
```


#For each cell, pairwise beta diversity is calculated for that focal cell and each of its 8 (or 7) neighbors, and the mean of those values is found
```{r}
Cell8CH <- as.character(Cell8)
Beta8 <- lapply(Cell8CH, function(x)mean(BetaMat[x, as.character(Neighbors8[,x])]))
names(Beta8) <- Cell8CH

Cell7CH <- as.character(Cell7)
Beta7 <- lapply(Cell7CH, function(x)mean(BetaMat[x, as.character(Neighbors7[,x])]))
names(Beta7) <- Cell7CH
```


#Plot mean pairwise beta diversity by Cell ID
```{r}
Beta7Vec<-unlist(Beta7)
Beta8Vec<-unlist(Beta8)
BetaVec <- rep(0, 15038)

BetaVec[Cell8]<-Beta8Vec
BetaVec[Cell7]<-Beta7Vec
BetaVec[BetaVec==0]<-NA

plot(BetaVec, ylab = "Mean Pairwise β-Diversity", xlab = "Cell ID")
```


#Load mapping packages and create colorscheme
```{r}
require(wesanderson)
require(ggplot2)
require(rasterVis)

cols <- rev(wes_palette("Zissou1", 500, type = "continuous"))
```


#Map beta diversity, adjust minimum value to remove outliers
```{r}
#go to this link for info on breaks, limits, etc.
#figure out a way to show values <0.5 as black on map
#https://stackoverflow.com/questions/24265652/label-minimum-and-maximum-of-scale-fill-gradient-legend-with-text-ggplot2

BetaRaster <- setValues(BlankRas, BetaVec)

theme_set(theme_void())
BetaMap <- gplot(BetaRaster, maxpixels=15038) + geom_raster(aes(fill = value)) + 
    scale_fill_gradientn(name="β-diversity", colours=cols, na.value="transparent", limits = c(0.5,1)) + 
    coord_equal() 
BetaMap
```


#Map alpha diversity (aka richness)
```{r}
RichnessVec <- readRDS("Data/RichnessVec.rds")
RichnessVec[which(RichnessVec==0)]=NA
RichnessRaster <- setValues(BlankRas, RichnessVec)

theme_set(theme_void())
RichnessMap <- gplot(RichnessRaster, maxpixels=15038) + geom_raster(aes(fill = value)) +   
    scale_fill_gradientn(name="α-diversity", colours=cols, na.value="transparent") +
    coord_equal() 
RichnessMap
```


#Map alpha and beta diversity side-by-side and save as png
```{r}
require(gridExtra)

png("bothmaps.png", width = 1000, height = 1000, pointsize = 20)
grid.arrange(RichnessMap, BetaMap, ncol=2)
dev.off()
```


#Plot Jaccard index against Sorensen (both are SIMILARITY)
```{r}
SorBetaVec <- readRDS("Data/SorBetaVec.rds")
SorBetaVec[SorBetaVec<0]<-NA
BetaVec[BetaVec<0]<-NA


plot(BetaVec, ylab = "β-diversity", xlab = "Cell ID", col="darkgreen")
points(SorBetaVec, col="skyblue2")
```


#Histogram of beta values
```{r}
BetaDF <- as.data.frame(BetaVec)
BetaPolygons <- rasterToPolygons(BetaRaster)

SorBetaRaster <- setValues(BlankRas, SorBetaVec)

histogram(BetaRaster, col=(rev(cols)))
histogram(SorBetaRaster, col=((cols)))
```


---
title: "Analysis of Bryophyte Richness and Diversity in the Americas"
author: Carter Powell, Jackie O'Malley, and Julia Eckberg
output: html_notebook
---

```{r}
require(knitr)
require(BIEN)
require(ape)
require(maps)
require(dplyr)
require(maptools)
require(raster)
require(dismo)
require(sp)
require(rgdal)
require(mapdata)
require(mapproj)
require(vegan)
require(letsR)
require(entropart)
require(betapart)
require(rgeos)
require(CommEcol)
require(rlist)
```


#Load blank raster and cell richness data + extract cell IDs and create vector for all cells
```{r}
BlankRas <-raster("Data/blank_100km_raster.tif")
CellRichness <- readRDS("Data/CellRichness.rds")
CellID <- CellRichness$CellID
cellvector <- c(1:15038)
```

#Identify occupied cells that are adjacent to each occuppied cell + convert to vector
```{r}
neighbor <- function(cellvector) {(adjacent(BlankRas, cellvector, directions=8, pairs=FALSE, target=CellID, sorted=TRUE, include=FALSE, id=FALSE))}
neighbors <- lapply(cellvector, neighbor)
names(neighbors) <- cellvector
neighbors <- neighbors[CellID]
neighbors <- unlist(lapply(neighbors, length))
```

#Separate out occuppied cells with 8 and 7 occuppied neighbors
```{r}
Cell8 <- CellID[which(neighbors==8)]
Cell7 <- CellID[which(neighbors==7)]
```

#Make beta diversity matrix for cells with 8 neighbors and cells with 7 neighbors
```{r}
readRDS(BetaMat, file = "Data/BetaMat.rds")

BetaMat8<-as.matrix(BetaMat)
BetaMat8[!Cell8, !Cell8, drop=TRUE]
inx8 <- match(as.character(Cell8), rownames(BetaMat8))
BetaMat8 <- BetaMat8[inx8,inx8]

BetaMat7<-as.matrix(BetaMat)
BetaMat7[!Cell7, !Cell7, drop=TRUE]
inx7 <- match(as.character(Cell7), rownames(BetaMat7))
BetaMat7 <- BetaMat7[inx7,inx7]
```

#Extract the vector of neighbors for each cell with 8 or 7 neighbors
```{r}
neighbors8 <-neighbors[Cell8]
neighbors7 <- neighbors[Cell7]

neighbors8 <- data.frame(neighbors8)
names(neighbors8)[1:3788] <- Cell8
neighbors7 <- data.frame(neighbors7)
names(neighbors7)[1:318] <- Cell7

row.names(BetaMat8) <- Cell8
names(BetaMat8)[1:3788] <- Cell8
row.names(BetaMat7) <- Cell7
names(BetaMat7)[1:318] <- Cell7

full.BetaMat <- as.matrix(BetaMat)
row.names(full.BetaMat) <- CellID
names(full.BetaMat)[1:4761] <- CellID
```


#Beta diversity for each cell and its 8neighbors
```{r}
Cell8_ch <- as.character(Cell8)
Cell7_ch <- as.character(Cell7)

ultimatebeta8 <- lapply(Cell8_ch, function(x)mean(full.BetaMat[x, as.character(neighbors8[,x])]))
names(ultimatebeta8) <- Cell8_ch
ultimatebeta7 <- lapply(Cell7_ch, function(x)mean(full.BetaMat[x, as.character(neighbors7[,x])]))
names(ultimatebeta7) <- Cell7_ch
plot(Cell8_ch, ultimatebeta8)
plot(Cell7_ch, ultimatebeta7)
points(Cell7_ch, ultimatebeta7)
#check on cell 767. it has crazy LOW value
```


#Plot richness
```{r}
betavector7<-unlist(ultimatebeta7)
betavector8<-unlist(ultimatebeta8)
cellmatrix <- as.matrix(cellvector)
x <- rep(0,15038)
x
x[Cell8]<-betavector8
x[Cell7]<-betavector7
x[x==0]<-NA
plot(cellvector, x)
#MAP
require(wesanderson)
cols <- rev(wes_palette("Zissou1", 500, type = "continuous"))
require(rasterVis)
#different way to plot, easier to mess with the breaks
x[x<0.5]<-NA
cellmatrix<-cbind(cellmatrix, x)
cellmatrix<-cellmatrix[,-1]
betavector<-as.vector(cellmatrix)
BetaRaster <- setValues(BlankRas, betavector)
spplot(BetaRaster,  maxpixels=15038, col.regions=cols)
gplot(BetaRaster,  maxpixels=15038)
library(ggplot2)
theme_set(theme_void())
gplot(BetaRaster) + geom_raster(aes(fill = value))+ scale_fill_gradientn(colours=cols, na.value="white") +
          coord_equal() 
#plot(BetaRaster, col=rev(cols), axes = F)
```
